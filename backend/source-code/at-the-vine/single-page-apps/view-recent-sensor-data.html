<!--
Jaye Hicks 2020

Lonesome Vine status single page web application.  User logon is required to access this application.
User ids and passwords are maintained in AWS Cognito.  Data that is displayed / updated by this
application is maintained across multiple AWS DynmoDB Tables.

Obligatory legal disclaimer:
 You are free to use this source code (this file and all other files 
 referenced in this file) "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER 
 EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED 
 WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. THE 
 ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THIS SOURCE CODE IS WITH 
 YOU.  SHOULD THE SOURCE CODE PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL 
 NECESSARY SERVICING, REPAIR OR CORRECTION. See the GNU GENERAL PUBLIC 
 LICENSE Version 3, 29 June 2007 for more details.
-->
<!DOCTYPE html>
<html>
<head>
<title>Lonesome Vine Operations Management</title>
<meta charset="UTF-8">
</head>
<body>
<img src="banner_small.jpg"><br>
<span id = "messageToUser">Howdy! I don't know who you are.  Please log on at the bottom of this page.</span><br><br>

<fieldset style="width:750px">
<legend> Vineyard Staions Current Sensor Readings</legend>
<input type="submit" class="buttons" value="Refresh Display" id="vineyardStationsRefresh" style="width:110px">
<br>
<br>
<table border="1">
<tr>
  <th align="left" style="padding:5px">Station</th>
  <th align="left" style="padding:5px">Status</th>
  <th align="left" style="padding:5px">Last Reported</th>
  <th align="left" style="padding:5px">12" SMS</th>
  <th align="left" style="padding:5px">24" SMS</th>
  <th align="left" style="padding:5px">48" SMS</th>   
  <th align="left" style="padding:5px">&#176F</th>
  <th align="left" style="padding:5px">Volts</th>
</tr>
<tr>
  <td style="padding:3px">A02N</td>
  <td style="padding:3px" id="A02N_status_color"> <span id = "A02N_status">...</span> </td>
  <td style="padding:3px" id="A02N_time_color"> <span id = "A02N_time">...</span> </td>
  <td style="padding:3px" id="A02N_sms1_color"> <span id = "A02N_sms1">...</span></td>
  <td style="padding:3px" id="A02N_sms2_color"> <span id = "A02N_sms2">...</span></td>
  <td style="padding:3px" id="A02N_sms3_color"> <span id = "A02N_sms3">...</span></td>
  <td style="padding:3px" id="A02N_temp_color"> <span id = "A02N_temp">...</span> </td>
  <td style="padding:3px" id="A02N_battery_color"> <span id = "A02N_battery">...</span> </td>
</tr>
<tr>
  <td style="padding:3px">A02S</td>
  <td style="padding:3px" id="A02S_status_color"> <span id = "A02S_status">...</span> </td>
  <td style="padding:3px" id="A02S_time_color"> <span id = "A02S_time">...</span> </td>
  <td style="padding:3px" id="A02S_sms1_color"> <span id = "A02S_sms1">...</span></td>
  <td style="padding:3px" id="A02S_sms2_color"> <span id = "A02S_sms2">...</span></td>
  <td style="padding:3px" id="A02S_sms3_color"> <span id = "A02S_sms3">...</span></td>
  <td style="padding:3px" id="A02S_temp_color"> <span id = "A02S_temp">...</span> </td>
  <td style="padding:3px" id="A02S_battery_color"> <span id = "A02S_battery">...</span> </td>
</tr>
<tr>
  <td style="padding:3px">A08M</td>
  <td style="padding:3px" id="A08M_status_color"> <span id = "A08M_status">...</span> </td>
  <td style="padding:3px" id="A08M_time_color"> <span id = "A08M_time">...</span> </td>
  <td style="padding:3px" id="A08M_sms1_color"> <span id = "A08M_sms1">...</span></td>
  <td style="padding:3px" id="A08M_sms2_color"> <span id = "A08M_sms2">...</span></td>
  <td style="padding:3px" id="A08M_sms3_color"> <span id = "A08M_sms3">...</span></td>  
  <td style="padding:3px" id="A08M_temp_color"> <span id = "A08M_temp">...</span> </td>
  <td style="padding:3px" id="A08M_battery_color"> <span id = "A08M_battery">...</span> </td>  
</tr>
<tr>
  <td style="padding:3px">B02N</td>
  <td style="padding:3px" id="B02N_status_color"> <span id = "B02N_status">...</span> </td>
  <td style="padding:3px" id="B02N_time_color"> <span id = "B02N_time">...</span> </td>
  <td style="padding:3px" id="B02N_sms1_color"> <span id = "B02N_sms1">...</span></td>
  <td style="padding:3px" id="B02N_sms2_color"> <span id = "B02N_sms2">...</span></td>
  <td style="padding:3px" id="B02N_sms3_color"> <span id = "B02N_sms3">...</span></td>
  <td style="padding:3px" id="B02N_temp_color"> <span id = "B02N_temp">...</span> </td>
  <td style="padding:3px" id="B02N_battery_color"> <span id = "B02N_battery">...</span> </td>  
</tr>
<tr>
  <td style="padding:3px">B02S</td>
  <td style="padding:3px" id="B02S_status_color"> <span id = "B02S_status">...</span> </td>
  <td style="padding:3px" id="B02S_time_color"> <span id = "B02S_time">...</span> </td>
  <td style="padding:3px" id="B02S_sms1_color"> <span id = "B02S_sms1">...</span></td>
  <td style="padding:3px" id="B02S_sms2_color"> <span id = "B02S_sms2">...</span></td>
  <td style="padding:3px" id="B02S_sms3_color"> <span id = "B02S_sms3">...</span></td>  
  <td style="padding:3px" id="B02S_temp_color"> <span id = "B02S_temp">...</span> </td>
  <td style="padding:3px" id="B02S_battery_color"> <span id = "B02S_battery">...</span> </td> 
</tr>
<tr>
  <td style="padding:3px">B08M</td>
  <td style="padding:3px" id="B08M_status_color"> <span id = "B08M_status">...</span> </td>
  <td style="padding:3px" id="B08M_time_color"> <span id = "B08M_time">...</span> </td>
  <td style="padding:3px" id="B08M_sms1_color"> <span id = "B08M_sms1">...</span></td>
  <td style="padding:3px" id="B08M_sms2_color"> <span id = "B08M_sms2">...</span></td>
  <td style="padding:3px" id="B08M_sms3_color"> <span id = "B08M_sms3">...</span></td>  
  <td style="padding:3px" id="B08M_temp_color"> <span id = "B08M_temp">...</span> </td>
  <td style="padding:3px" id="B08M_battery_color"> <span id = "B08M_battery">...</span> </td>
</tr>
<tr>
  <td style="padding:3px">C02N</td>
  <td style="padding:3px" id="C02N_status_color"> <span id = "C02N_status">...</span> </td>
  <td style="padding:3px" id="C02N_time_color"> <span id = "C02N_time">...</span> </td>
  <td style="padding:3px" id="C02N_sms1_color"> <span id = "C02N_sms1">...</span></td>
  <td style="padding:3px" id="C02N_sms2_color"> <span id = "C02N_sms2">...</span></td>
  <td style="padding:3px" id="C02N_sms3_color"> <span id = "C02N_sms3">...</span></td>
  <td style="padding:3px" id="C02N_temp_color"> <span id = "C02N_temp">...</span> </td>
  <td style="padding:3px" id="C02N_battery_color"> <span id = "C02N_battery">...</span> </td> 
</tr>
<tr>
  <td style="padding:3px">C02S</td>
  <td style="padding:3px" id="C02S_status_color"> <span id = "C02S_status">...</span> </td>
  <td style="padding:3px" id="C02S_time_color"> <span id = "C02S_time">...</span> </td>
  <td style="padding:3px" id="C02S_sms1_color"> <span id = "C02S_sms1">...</span></td>
  <td style="padding:3px" id="C02S_sms2_color"> <span id = "C02S_sms2">...</span></td>
  <td style="padding:3px" id="C02S_sms3_color"> <span id = "C02S_sms3">...</span></td>
  <td style="padding:3px" id="C02S_temp_color"> <span id = "C02S_temp">...</span> </td>
  <td style="padding:3px" id="C02S_battery_color"> <span id = "C02S_battery">...</span> </td>
</tr>
<tr>
  <td style="padding:3px">C08M</td>
  <td style="padding:3px" id="C08M_status_color"> <span id = "C08M_status">...</span> </td>
  <td style="padding:3px" id="C08M_time_color"> <span id = "C08M_time">...</span> </td>
  <td style="padding:3px" id="C08M_sms1_color"> <span id = "C08M_sms1">...</span></td>
  <td style="padding:3px" id="C08M_sms2_color"> <span id = "C08M_sms2">...</span></td>
  <td style="padding:3px" id="C08M_sms3_color"> <span id = "C08M_sms3">...</span></td>
  <td style="padding:3px" id="C08M_temp_color"> <span id = "C08M_temp">...</span> </td>
  <td style="padding:3px" id="C08M_battery_color"> <span id = "C08M_battery">...</span> </td>
</tr>
<tr>
  <td style="padding:3px">D02N</td>
  <td style="padding:3px" id="D02N_status_color"> <span id = "D02N_status">...</span> </td>
  <td style="padding:3px" id="D02N_time_color"> <span id = "D02N_time">...</span> </td>
  <td style="padding:3px" id="D02N_sms1_color"> <span id = "D02N_sms1">...</span></td>
  <td style="padding:3px" id="D02N_sms2_color"> <span id = "D02N_sms2">...</span></td>
  <td style="padding:3px" id="D02N_sms3_color"> <span id = "D02N_sms3">...</span></td>
  <td style="padding:3px" id="D02N_temp_color"> <span id = "D02N_temp">...</span> </td>
  <td style="padding:3px" id="D02N_battery_color"> <span id = "D02N_battery">...</span> </td> 
</tr>
<tr>
  <td style="padding:3px">D02S</td>
  <td style="padding:3px" id="D02S_status_color"> <span id = "D02S_status">...</span> </td>
  <td style="padding:3px" id="D02S_time_color"> <span id = "D02S_time">...</span> </td>
  <td style="padding:3px" id="D02S_sms1_color"> <span id = "D02S_sms1">...</span></td>
  <td style="padding:3px" id="D02S_sms2_color"> <span id = "D02S_sms2">...</span></td>
  <td style="padding:3px" id="D02S_sms3_color"> <span id = "D02S_sms3">...</span></td>
  <td style="padding:3px" id="D02S_temp_color"> <span id = "D02S_temp">...</span> </td>
  <td style="padding:3px" id="D02S_battery_color"> <span id = "D02S_battery">...</span> </td>
</tr>
<tr>
  <td style="padding:3px">D08M</td>
  <td style="padding:3px" id="D08M_status_color"> <span id = "D08M_status">...</span> </td>
  <td style="padding:3px" id="D08M_time_color"> <span id = "D08M_time">...</span> </td>
  <td style="padding:3px" id="D08M_sms1_color"> <span id = "D08M_sms1">...</span></td>
  <td style="padding:3px" id="D08M_sms2_color"> <span id = "D08M_sms2">...</span></td>
  <td style="padding:3px" id="D08M_sms3_color"> <span id = "D08M_sms3">...</span></td>
  <td style="padding:3px" id="D08M_temp_color"> <span id = "D08M_temp">...</span> </td>
  <td style="padding:3px" id="D08M_battery_color"> <span id = "D08M_battery">...</span> </td>  
</tr>
<tr>
  <td style="padding:3px">E02N</td>
  <td style="padding:3px" id="E02N_status_color"> <span id = "E02N_status">...</span> </td>
  <td style="padding:3px" id="E02N_time_color"> <span id = "E02N_time">...</span> </td>
  <td style="padding:3px" id="E02N_sms1_color"> <span id = "E02N_sms1">...</span></td>
  <td style="padding:3px" id="E02N_sms2_color"> <span id = "E02N_sms2">...</span></td>
  <td style="padding:3px" id="E02N_sms3_color"> <span id = "E02N_sms3">...</span></td>
  <td style="padding:3px" id="E02N_temp_color"> <span id = "E02N_temp">...</span> </td>
  <td style="padding:3px" id="E02N_battery_color"> <span id = "E02N_battery">...</span> </td>  
</tr>
<tr>
  <td style="padding:3px">E02S</td>
  <td style="padding:3px" id="E02S_status_color"> <span id = "E02S_status">...</span> </td>
  <td style="padding:3px" id="E02S_time_color"> <span id = "E02S_time">...</span> </td>
  <td style="padding:3px" id="E02S_sms1_color"> <span id = "E02S_sms1">...</span></td>
  <td style="padding:3px" id="E02S_sms2_color"> <span id = "E02S_sms2">...</span></td>
  <td style="padding:3px" id="E02S_sms3_color"> <span id = "E02S_sms3">...</span></td>
  <td style="padding:3px" id="E02S_temp_color"> <span id = "E02S_temp">...</span> </td>
  <td style="padding:3px" id="E02S_battery_color"> <span id = "E02S_battery">...</span> </td> 
</tr>
<tr>
  <td style="padding:3px">E08M</td>
  <td style="padding:3px" id="E08M_status_color"> <span id = "E08M_status">...</span> </td>
  <td style="padding:3px" id="E08M_time_color"> <span id = "E08M_time">...</span> </td>
  <td style="padding:3px" id="E08M_sms1_color"> <span id = "E08M_sms1">...</span></td>
  <td style="padding:3px" id="E08M_sms2_color"> <span id = "E08M_sms2">...</span></td>
  <td style="padding:3px" id="E08M_sms3_color"> <span id = "E08M_sms3">...</span></td>
  <td style="padding:3px" id="E08M_temp_color"> <span id = "E08M_temp">...</span> </td>
  <td style="padding:3px" id="E08M_battery_color"> <span id = "E08M_battery">...</span> </td>
</tr>
<tr>
  <td style="padding:3px">F02N</td>
  <td style="padding:3px" id="F02N_status_color"> <span id = "F02N_status">...</span> </td>
  <td style="padding:3px" id="F02N_time_color"> <span id = "F02N_time">...</span> </td>
  <td style="padding:3px" id="F02N_sms1_color"> <span id = "F02N_sms1">...</span></td>
  <td style="padding:3px" id="F02N_sms2_color"> <span id = "F02N_sms2">...</span></td>
  <td style="padding:3px" id="F02N_sms3_color"> <span id = "F02N_sms3">...</span></td>
  <td style="padding:3px" id="F02N_temp_color"> <span id = "F02N_temp">...</span> </td>
  <td style="padding:3px" id="F02N_battery_color"> <span id = "F02N_battery">...</span> </td>  
</tr>
<tr>
  <td style="padding:3px">F02S</td>
  <td style="padding:3px" id="F02S_status_color"> <span id = "F02S_status">...</span> </td>
  <td style="padding:3px" id="F02S_time_color"> <span id = "F02S_time">...</span> </td>
  <td style="padding:3px" id="F02S_sms1_color"> <span id = "F02S_sms1">...</span></td>
  <td style="padding:3px" id="F02S_sms2_color"> <span id = "F02S_sms2">...</span></td>
  <td style="padding:3px" id="F02S_sms3_color"> <span id = "F02S_sms3">...</span></td>
  <td style="padding:3px" id="F02S_temp_color"> <span id = "F02S_temp">...</span> </td>
  <td style="padding:3px" id="F02S_battery_color"> <span id = "F02S_battery">...</span> </td>
</tr>
<tr>
  <td style="padding:3px">F08M</td>
  <td style="padding:3px" id="F08M_status_color"> <span id = "F08M_status">...</span> </td>
  <td style="padding:3px" id="F08M_time_color"> <span id = "F08M_time">...</span> </td>
  <td style="padding:3px" id="F08M_sms1_color"> <span id = "F08M_sms1">...</span></td>
  <td style="padding:3px" id="F08M_sms2_color"> <span id = "F08M_sms2">...</span></td>
  <td style="padding:3px" id="F08M_sms3_color"> <span id = "F08M_sms3">...</span></td>
  <td style="padding:3px" id="F08M_temp_color"> <span id = "F08M_temp">...</span> </td>
  <td style="padding:3px" id="F08M_battery_color"> <span id = "F08M_battery">...</span> </td> 
</tr>
<tr>
  <td style="padding:3px">G02N</td>
  <td style="padding:3px" id="G02N_status_color"> <span id = "G02N_status">...</span> </td>
  <td style="padding:3px" id="G02N_time_color"> <span id = "G02N_time">...</span> </td>
  <td style="padding:3px" id="G02N_sms1_color"> <span id = "G02N_sms1">...</span></td>
  <td style="padding:3px" id="G02N_sms2_color"> <span id = "G02N_sms2">...</span></td>
  <td style="padding:3px" id="G02N_sms3_color"> <span id = "G02N_sms3">...</span></td>
  <td style="padding:3px" id="G02N_temp_color"> <span id = "G02N_temp">...</span> </td>
  <td style="padding:3px" id="G02N_battery_color"> <span id = "G02N_battery">...</span> </td>  
</tr>
<tr>
  <td style="padding:3px">G02S</td>
  <td style="padding:3px" id="G02S_status_color"> <span id = "G02S_status">...</span> </td>
  <td style="padding:3px" id="G02S_time_color"> <span id = "G02S_time">...</span> </td>
  <td style="padding:3px" id="G02S_sms1_color"> <span id = "G02S_sms1">...</span></td>
  <td style="padding:3px" id="G02S_sms2_color"> <span id = "G02S_sms2">...</span></td>
  <td style="padding:3px" id="G02S_sms3_color"> <span id = "G02S_sms3">...</span></td>
  <td style="padding:3px" id="G02S_temp_color"> <span id = "G02S_temp">...</span> </td>
  <td style="padding:3px" id="G02S_battery_color"> <span id = "G02S_battery">...</span> </td>  
</tr>
<tr>
  <td style="padding:3px">G08M</td>
  <td style="padding:3px" id="G08M_status_color"> <span id = "G08M_status">...</span> </td>
  <td style="padding:3px" id="G08M_time_color"> <span id = "G08M_time">...</span> </td>
  <td style="padding:3px" id="G08M_sms1_color"> <span id = "G08M_sms1">...</span></td>
  <td style="padding:3px" id="G08M_sms2_color"> <span id = "G08M_sms2">...</span></td>
  <td style="padding:3px" id="G08M_sms3_color"> <span id = "G08M_sms3">...</span></td>
  <td style="padding:3px" id="G08M_temp_color"> <span id = "G08M_temp">...</span> </td>
  <td style="padding:3px" id="G08M_battery_color"> <span id = "G08M_battery">...</span> </td>  
</tr>
</table>
</fieldset>
<br>
<br>

<fieldset style="width:750px">
<legend> Sensor Records</legend>
<input type="submit" class="buttons" value="Today" id="sensorRecordsToday" style="width:55px"> 
&nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp &nbsp

&nbsp
Year: <input type="text" id="sensorInputYear" style="width:30px" size="4" maxlength="4" name="sensorInputYear"> 
Month: <input type="text" id="sensorInputMonth" style="width:15px" size="2" maxlength="2" name="sensorInputMonth">
Day: <input type="text" id="sensorInputDay" style="width:15px" size="2" maxlength="2" name="sensorInputDay"> 
&nbsp &nbsp &nbsp <input type="submit" class="buttons" value="Go" id="sensorRecordsSetDate" style="width:35px">
<br>
&nbsp &nbsp &nbsp <i><small>(oldest sensor data in database: <span id = "oldestSensorRecordDate">...</span>)</small></i>
<br>
<br>
<b>Date: </b> <span id = "sensorRecordDate">...</span>
<table id = "sensorRecordsTable" border="1">
<tr>
  <th align="left" style="width:75px">Date</th>
  <th align="left" style="padding:5px">Day+TimeStamp+Station</th>
  <th align="left" style="padding:5px">Temp</th>
  <th align="left" style="padding:5px">Battery</th>
  <th align="left" style="padding:5px">12" SMS</th>
  <th align="left" style="padding:5px">24" SMS</th>
  <th align="left" style="padding:5px">48" SMS</th>
  <th align="left" style="padding:5px">ID</th>
</tr>
</table>
</fieldset>
<br>
<br>

<fieldset style="width:510px">
<legend> Logon</legend>
<b>User Name:</b> &nbsp &nbsp
<input type="text" id="username" name="username">
<br><br>
<b>Password:</b> &nbsp &nbsp
<input type="password" id="password" name="password">
<br><br>
<button onclick="LogInToApp()" id="logonbutton">Logon</button>
</fieldset>

<script src="amazon-cognito-identity.min.js"> </script>
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.331.0.min.js"></script>

<script>
	  
/////////////////////////////////////////////////////////////////////////////////////////
// Generic data stuctures and utility functions
/////////////////////////////////////////////////////////////////////////////////////////
var vineyard_stations = ["A02N", "A02S", "A08M", "B02N", "B02S", "B08M", "C02N",
                         "C02S", "C08M", "D02N", "D02S", "D08M", "E02N", "E02S", 
						 "E08M", "F02N", "F02S", "F08M", "G02N", "G02S", "G08M"];
var days_in_months = [0,31,28,31,30,31,30,31,31,30,31,30,31];
					   
const CONSOLE 			= 1;
const GUI 				= 2;
const CONSOLE_AND_GUI 	= 3;

const LONG 				= 1;
const SHORT 			= 2;

var sensorRecordDate = '';
var oldestSensorRecordDate = 0;

//handles leap years
function GetDaysOfMonth(year, month)
{
  var days = 0;
  var is_leap = false;
  
  if((year > 0) && ((month > 0) && (month < 13)))
  {
    //detect a leap year
    if (year % 4 != 0)
    {
      is_leap = false;
    }
    else if (year % 100 != 0)
    {
      is_leap = true;
    }
    else if (year % 400 != 0)
    {
      is_leap = false;
    }
    else
    {
      is_leap = true; 
    }
	
	//get the number of days
    if(is_leap && (month == 2))
    {
      days = 29;
    }
    else
	{
      days = days_in_months[month];
	}
  }
  return(days);
}

function SendMessage(destination, message)
{
  if(message.length > 0)
  {
    if((destination == CONSOLE) || (destination == CONSOLE_AND_GUI))
    {
      console.log(message);
    }
  
    if((destination == GUI) || (destination == CONSOLE_AND_GUI))
    {
      document.getElementById("messageToUser").innerHTML = message;
    }
  }
}

function ClearTable(table_id)
{
  var table = document.getElementById(table_id);

  //deletes all rows except the header row
  for(var i = table.rows.length - 1; i > 0; i--)
  {
    table.deleteRow(i);
  }
}

//parameter == false will enable the GUI; true will disable
function SetTheGUI(mode)
{
  document.getElementById("vineyardStationsRefresh").disabled = mode;

  document.getElementById("sensorRecordsToday").disabled = mode;
  document.getElementById("sensorRecordsSetDate").disabled = mode;

  document.getElementById("sensorInputYear").disabled = mode;
  document.getElementById("sensorInputYear").value = '';
  document.getElementById("sensorInputMonth").disabled = mode;
  document.getElementById("sensorInputMonth").value = '';
  document.getElementById("sensorInputDay").disabled = mode;
  document.getElementById("sensorInputDay").value = '';
}

function DisableTheGUI()
{
  document.getElementById("vineyardStationsRefresh").disabled = true;

  document.getElementById("sensorRecordsToday").disabled = true;
  document.getElementById("sensorRecordsSetDate").disabled = true;

  document.getElementById("sensorInputYear").disabled = true;
  document.getElementById("sensorInputYear").value = '';
  document.getElementById("sensorInputMonth").disabled = true;
  document.getElementById("sensorInputMonth").value = '';
  document.getElementById("sensorInputDay").disabled = true;
  document.getElementById("sensorInputDay").value = '';
}

function ClearInputValues()
{
  document.getElementById("sensorInputYear").value = '';
  document.getElementById("sensorInputMonth").value = '';  
  document.getElementById("sensorInputDay").value = '';
}

// given a number, return a 2 char string, left padded with '0' if needed
function PadLeftZero(value)
{
  var return_string = "";
  if(value < 10)
  {
    return_string = "0";
  }
  return_string += value.toString();
  return(return_string);
}

//convert epoch time stamp to human readable string. e.g. 2020-12-31T23:59
function TimeStampToHuman(timestamp, mode)
{
  var human_readable = "";

  var reg_exp = new RegExp('^[0-9]+$');
  if(reg_exp.test(timestamp))
  {	
	var date = new Date(timestamp * 1000);  // need to supply milliseconds
	var year = date.getFullYear();
	human_readable = year.toString() + "-";
	var month = date.getMonth() + 1;  //due to Jan == 0
	human_readable += PadLeftZero(month)
    if(mode == LONG)
    {
	  var day = date.getDate();
	  human_readable += "-" + PadLeftZero(day) + "T";
	  var hours = date.getHours();
	  human_readable += PadLeftZero(hours) + ":";
	  var minutes = date.getMinutes();
	  human_readable += PadLeftZero(minutes);
	}
  }
  else
  {
	SendMessage(CONSOLE, "Bad argument passed to TimeStampToHuman(). Contains non digits.");
  }
  return(human_readable);
}

//return current date in year-month-day format (e.g., 2019-12-29)
function ReturnCurrentYearMonthDay()
{
  var dateObj = new Date();
  var month = dateObj.getMonth() + 1; //due to Jan == 0
  var day = dateObj.getDate();
  var year = dateObj.getFullYear();
  var formattedDate = year.toString() + '-' + PadLeftZero(month) + '-' + PadLeftZero(day);
  return(formattedDate);
}

// take number date, insert hyphens, and return as string (e.g., 20191101 -> '2019-11-01')
function GetDisplayDate(oldest_date)
{
  var output_string = '';
  if(oldest_date != 0)
  {
    var oldest_date_string = oldest_date.toString();
	output_string = oldest_date_string.substring(0,4);
	output_string += '-' + oldest_date_string.substring(4,6);
	output_string += '-' + oldest_date_string.substring(6,8);
  }

  return(output_string);
}

/////////////////////////////////////////////////////////////////////////////////////////
// Security data structures and functions
/////////////////////////////////////////////////////////////////////////////////////////
var THE_REGION = 'us-east-1';
var USER_POOL_ID = 'us-east-1_123456789';
var USER_POOL_APP_CLIENT_ID = '1234567890123456789012345678';
var IDENTITY_POOL_ID = 'us-east-1:12345678-1234-1234-1234-123456789012';

// clear user input from log in attempt
function ClearLogInValues()
{
  document.getElementById("password").value = '';
  document.getElementById("username").value = '';
}

// attempt by user to log into web application succeeded
function LogInSuccess(name)
{
  var greeting = "Howdy " + name + "! You have been successfully logged in.";
  SendMessage(GUI, greeting);
  ClearLogInValues();
  document.getElementById("username").disabled = true; 
  document.getElementById("password").disabled = true; 
  document.getElementById("logonbutton").disabled = true;
  
  //enable GUI
  SetTheGUI(false);
  
  GetOldestSensorRecordDate();

  LoadMostRecentSensorReadings();
  LoadFirstPageOfSensorRecords();
}

// attempt by user to log into web application failed
function LogInFailure()
{
  SendMessage(GUI, "Sorry partner! Please try to log in again.");
  ClearLogInValues();
}

// process user's attempt to log into the web application  	  
function LogInToApp()
{
  SendMessage(GUI, "Attempting to log you in...");
  var authenticationData = 
  {
    Username : document.getElementById("username").value,
    Password : document.getElementById("password").value
  }; 
  var authenticationDetails = 
    new AmazonCognitoIdentity.AuthenticationDetails(authenticationData);
  var poolData = 
  { 
	UserPoolId : USER_POOL_ID,
	ClientId : USER_POOL_APP_CLIENT_ID
  };
  var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
  var userData = 
  { 
    Username : document.getElementById("username").value,
    Pool : userPool
  };
  var cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
  cognitoUser.authenticateUser(authenticationDetails, 
  {
    onSuccess: function (result) 
	{
	  var accessToken = result.getAccessToken().getJwtToken();
	  AWS.config.region = THE_REGION;
      AWS.config.credentials = new AWS.CognitoIdentityCredentials(
	    {
          IdentityPoolId : IDENTITY_POOL_ID,
		  Logins : 
		  { 	
		    //'cognito-idp.' + <aws region> + '.amazonaws.com/' + <cognito user pool id>
			'cognito-idp.us-east-1.amazonaws.com/us-east-1_123456789'  : 
		    result.getIdToken().getJwtToken()
          }
        }
	  );

      AWS.config.credentials.refresh((error) => 
	    {
          if (error) 
		  {
		    SendMessage(CONSOLE, "Error: credentials refresh failed.");
		    SendMessage(CONSOLE, error);
		    LogInFailure();
          } 
		  else 
		  {
		    SendMessage(CONSOLE, 'Successfully logon and credential refresh.');
		    LogInSuccess(userData.Username);
			//now JavaScript functions can access AWS resources
		    AWS.config.update(
			  {
		        accessKeyId: AWS.config.credentials.accessKeyId, 
			    secretAccessKey: AWS.config.credentials.secretAccessKey,
			    sessionToken: AWS.config.credentials.sessionToken
		      }
		    );
          }
        }
	  );
    },

    onFailure: function(err) 
	{
	  SendMessage(CONSOLE, "Failure to log user into application.");
	  SendMessage(CONSOLE, err);
	  LogInFailure();
    },
    
    // MFA not used with this application
	mfaRequired: function(codeDeliveryDetails) 
	{
      var verificationCode = prompt('Please input verification code' ,'');
      cognitoUser.sendMFACode(verificationCode, this);
    },
	
	newPasswordRequired: function(userAttributes, requiredAttributes) 
	{
	  var newPassword = prompt("Please enter a new password. You must use an upper, " +
                               "lower, number, and a special; min 8 chars.", "");
	  if (newPassword == null || newPassword == "" || newPassword.length < 8)
      {
	    SendMessage(CONSOLE, "New password malformed.  Password reset failed.");
		LogInFailure();
	  }
	  else
	  {
	    document.getElementById("password").setAttribute('value',newPassword);
	    cognitoUser.completeNewPasswordChallenge(newPassword, null, this);
	    LogInSuccess(userData.Username);
		SendMessage(CONSOLE, "Password reset succeeded.");
      }
	}
  });
}

/////////////////////////////////////////////////////////////////////////////////////////
// Vineyard Stations Status Functions
/////////////////////////////////////////////////////////////////////////////////////////
function HookUpVineyardStationButtons()
{    
  document.getElementById("vineyardStationsRefresh").onclick = function()
    { RefreshVineyardStationsDisplay(); } 
}

function RefreshVineyardStationsDisplay()
{
  LoadMostRecentSensorReadings();
}

//Load the latest values for all sensor stations, both online ('status' cell will be marked
//green) and offline ('status' cell will be marked red).  For online stations, mark suspect
//sensor values (i.e., values which may constitute an alarm state) yellow.  A yellow indicator 
//is not definitive indication of an alarm state because data shelf life is not considered and 
//the full soil moisture algorithm is not executed.
//
//NOTE: Breaking this function up (i.e., separate AWS calls) would introduce race condition issues 
//stemming from asynchronous nature of the access to AWS resources.  Specifically, it is likely 
//that variables holding control values retrieved from table_name1 would still be undefined 
//at the time an attempt is made to color code cells based on current sensor readings.
function LoadMostRecentSensorReadings()
{
  SendMessage(GUI, "Loading most recent readings for all sensors...");
   	
  var docClient = new AWS.DynamoDB.DocumentClient();
  var params = 
  {
    TableName: 'table_name1',
    Key:
	{
      "control_id": '1'
    }
  }
  
  //get the sensor threshold values
  docClient.get(params, function(err, data) 
  {
    if (err) 
	{
	  SendMessage(CONSOLE_AND_GUI, "Cannot read the DynamoDB table table_name1." +
	                               " Try logging in again or launching a new browser.");
	  SendMessage(CONSOLE, err);
    } 
	else 
	{			
	  var absence_thresh =  parseInt(data.Item.absence_thresh);
	  var temp_thresh    =  parseFloat(data.Item.freeze_thresh);
      var battery_thresh = parseFloat(data.Item.battery_thresh);
	  var moist_thresh   = 99999999999;
	  var current_ts     = Math.trunc(Date.now() / 1000);
		
	  for (var index = 0; index < vineyard_stations.length; index++)
      {
		if(parseInt(data.Item.moisture_thresh[vineyard_stations[index]]) < moist_thresh)
		{
		  moist_thresh = parseInt(data.Item.moisture_thresh[vineyard_stations[index]]);
		}
	  }
		
	  //get the most current sensor values; load value and color code cells
	  var docClient = new AWS.DynamoDB.DocumentClient();
      var params = 
      {
        TableName: 'table_name2'
      };
   
      docClient.scan(params, function(err, data)
      {
        if(err) 
        {
          SendMessage(CONSOLE_AND_GUI, "Could not scan the DynamoDB table " +
	        "table_name2. Try logging in again or launching a new browser.");
	      SendMessage(CONSOLE, err);
        } 
        else 
        {
		  data.Items.forEach(function(statusRecord) 
	      {
		    document.getElementById(statusRecord.location + "_status").innerHTML = statusRecord.tstatus;
	        if(statusRecord.tstatus == 'online')
	        {
	          document.getElementById(statusRecord.location + '_status_color').bgColor = "lightgreen";
	        }
			else
		    {
		      document.getElementById(statusRecord.location + '_status_color').bgColor = "salmon";  
			}
			
	        document.getElementById(statusRecord.location + "_time").innerHTML = 
	          TimeStampToHuman(statusRecord.tstamp, LONG);
	        document.getElementById(statusRecord.location + "_time_color").bgColor = "white";
		    if((statusRecord.tstatus == 'online') && 
			   (current_ts - statusRecord.tstamp > (absence_thresh * 86,400))) //86,400 secs in a day
	        {
	          document.getElementById(statusRecord.location + "_time_color").bgColor = "lightyellow";
	        }
			  
		    document.getElementById(statusRecord.location + "_temp").innerHTML = statusRecord.temperature;
	        document.getElementById(statusRecord.location + "_temp_color").bgColor = "white";
			if((statusRecord.tstatus == 'online') && (parseFloat(statusRecord.temperature) <= temp_thresh))
	        {
	          document.getElementById(statusRecord.location + "_temp_color").bgColor = "lightyellow";
	        }
			 
		    document.getElementById(statusRecord.location + "_sms1").innerHTML = statusRecord.sms1;
	        document.getElementById(statusRecord.location + "_sms1_color").bgColor = "white"; 
		    if((statusRecord.tstatus == 'online') && (parseInt(statusRecord.sms1) >= moist_thresh))
	        {
	          document.getElementById(statusRecord.location + "_sms1_color").bgColor = "lightyellow";
	        }
			  
		    document.getElementById(statusRecord.location + "_sms2").innerHTML = statusRecord.sms2;
	        document.getElementById(statusRecord.location + "_sms2_color").bgColor = "white"; 
		    if((statusRecord.tstatus == 'online') && (parseInt(statusRecord.sms2) >= moist_thresh))
	        {
	          document.getElementById(statusRecord.location + "_sms2_color").bgColor = "lightyellow";
	        }
			  
			document.getElementById(statusRecord.location + "_sms3").innerHTML = statusRecord.sms3;
	        document.getElementById(statusRecord.location + "_sms3_color").bgColor = "white"; 
			if((statusRecord.tstatus == 'online') && (parseInt(statusRecord.sms3) >= moist_thresh))
	        {
	          document.getElementById(statusRecord.location + "_sms3_color").bgColor = "lightyellow";
	        }
			  
		    document.getElementById(statusRecord.location + "_battery").innerHTML = statusRecord.battery;
	        document.getElementById(statusRecord.location + "_battery_color").bgColor = "white"; 
		    if((statusRecord.tstatus == 'online') && (parseFloat(statusRecord.battery) <= battery_thresh))
	        {
	          document.getElementById(statusRecord.location + "_battery_color").bgColor = "lightyellow";
	        }
		  }); 
		  
		  SendMessage(GUI, "Finished loading most recent sensor status.");
        } 
      });
	}
  });
}


/////////////////////////////////////////////////////////////////////////////////////////
// Sensor Data Records Functions
/////////////////////////////////////////////////////////////////////////////////////////
function HookUpSensorRecordsButtons()
{    
  document.getElementById("sensorRecordsToday").onclick = function()
    { LoadFirstPageOfSensorRecords(); } 
  document.getElementById("sensorRecordsSetDate").onclick = function()
	{ LoadSpecificDateOfSensorRecords(document.getElementById("sensorInputYear").value,
	  document.getElementById("sensorInputMonth").value, 
	  document.getElementById("sensorInputDay").value);  }	
}

// scan database with sensor records, find oldest date, and set global variable.
// the entire point of exercise is to tell user date of oldest sensor record.
function GetOldestSensorRecordDate()
{
  SendMessage(GUI, "Scanning all sensor records to identify oldest...");
  var docClient = new AWS.DynamoDB.DocumentClient();
  var params = 
  {
    TableName: 'table_name3',
	ProjectionExpression: '#d, day_ts_loc',
	ExpressionAttributeNames:{'#d': 'date'}
  };
  docClient.scan(params, OnSensorRecordsScan);
}


function OnSensorRecordsScan(err, data)
{
  if (err) 
  {
    SendMessage(CONSOLE, "Error during table_name3 DynamoDB table scan.");
	SendMessage(CONSOLE, err);
    SendMessage(GUI, "Could not load page of sensor records.");
	oldestSensorRecordDate = 0;
    document.getElementById("oldestSensorRecordDate").innerHTML = '...';
  } 
  else 
  {
	if(data.Count > 0)
	{
      var dateValue = 0;
      data.Items.forEach(
	    function(item) 
	    {
	      dateValue = parseInt(item.date.replaceAll('-','') + 
			                   item.day_ts_loc.substring(0,2));
		  if (oldestSensorRecordDate == 0)
		  {
		    oldestSensorRecordDate = dateValue;
		  }
		  else
		  {
			if(dateValue < oldestSensorRecordDate)
			{
			  oldestSensorRecordDate = dateValue;
			}
          }
		});
	  
      SendMessage(GUI, "Finished loading a page of sensor records.");

      //is there more than a single result set page?
      if (typeof data.LastEvaluatedKey != "undefined") 
	  { 
	    var params = 
        {
          TableName: 'table_name3',
		  ExclusiveStartKey: data.LastEvaluatedKey,
	      ProjectionExpression: '#d, day_ts_loc',
	      ExpressionAttributeNames:{'#d': 'date'}
        };
	  
        var docClient = new AWS.DynamoDB.DocumentClient();
	    SendMessage(GUI, "Loading next page of sensor records...");
        docClient.scan(params, OnSensorRecordsScan);
	  }
	  else
	  {
	    SendMessage(GUI, "Finished scanning all sensor records.");
	    
		//tell user date of oldest sensor record in database	
	    if(oldestSensorRecordDate != 0)
	    {
          document.getElementById("oldestSensorRecordDate").innerHTML = 
	        GetDisplayDate(oldestSensorRecordDate);
	      oldestSensorRecordDate = 0;
	    }
	    else
	    {
	      document.getElementById("oldestSensorRecordDate").innerHTML = '...';
	    }
	  }
	}
	else
	{
      SendMessage(GUI, "Sensor readings database contains no records.");
	  document.getElementById("oldestSensorRecordDate").innerHTML = '...';
	  oldestSensorRecordDate = 0;
	}
  }
}

function LoadFirstPageOfSensorRecords()
{
  ClearTable("sensorRecordsTable");
  sensorRecordDate = ReturnCurrentYearMonthDay();
  
  //VinSensorData partition key is 'year-mo.' Global variable sensorRecordDate
  //contains 'year-mo-dy' so drop the '-dy' when matching a date. 'dy' is used
  //in 'begins_with' function used on sort key to get all records for specific day
  var parts = sensorRecordDate.split('+');
  var params = 
  {
    TableName: 'table_name3',
	KeyConditionExpression: '#dt = :ym and begins_with(day_ts_loc, :d)',
	ScanIndexForward: false,
    ExpressionAttributeNames: {'#dt': 'date'},
	ExpressionAttributeValues: {':ym': sensorRecordDate.substring(0,7), 
	                            ':d' : sensorRecordDate.substring(8,10)}
  };
  
  var docClient = new AWS.DynamoDB.DocumentClient();
  SendMessage(GUI, "Loading todays sensor data records...");
  docClient.query(params, OnSensorRecordsQuery);
}

function LoadSpecificDateOfSensorRecords(year, month, day)
{
  year_str = year.trim();
  month_str = month.trim();
  day_str = day.trim();

  var reg_exp = new RegExp('^[0-9]+$');  //digits only
  if((reg_exp.test(year_str)) && (reg_exp.test(month_str)) && (reg_exp.test(day_str)))
  {
    year_int = parseInt(year_str);
    month_int = parseInt(month_str);
    day_int = parseInt(day_str);
    if((year_int > 2019) && ((month_int > 0) && (month_int < 13)) &&
       ((day_int > 0) && (day_int <= GetDaysOfMonth(year_int, month_int)))) 
    {
	  ClearTable("sensorRecordsTable");
	  sensorRecordDate = year + '-' + PadLeftZero(month_int) + '-' + PadLeftZero(day_int);
      //VinSensorData partition key is 'year-mo.' Global variable sensorRecordDate
      //contains 'year-mo-dy' so drop the '-dy' when matching a date. 'dy' is used
      //in 'begins_with' function used on sort key to get all records for specific day
      var params = 
      {		
		TableName: 'table_name3',
	    KeyConditionExpression: '#dt = :ym and begins_with(day_ts_loc, :d)',
	    ScanIndexForward: false,
        ExpressionAttributeNames: {'#dt': 'date'},
	    ExpressionAttributeValues: {':ym': sensorRecordDate.substring(0,7), 
	                                ':d' : sensorRecordDate.substring(8,10)} 
      };
  
      var docClient = new AWS.DynamoDB.DocumentClient();
      SendMessage(GUI, "Loading sensor records for specific date...");
      docClient.query(params, OnSensorRecordsQuery);
    }
	else
	{
	  alert("An invalid date was specified.");
	  ClearInputValues();
	  sensorRecordDate = '';
	}
  }
  else
  {
    alert("Please enter digits (e.g., 0-9) to specify desired date."); 
	ClearInputValues();
	sensorRecordDate = '';
  }
}

function OnSensorRecordsQuery(err, data)
{
  if (err) 
  {
    SendMessage(CONSOLE, "Error during table_name3 DynamoDB table query.");
	SendMessage(CONSOLE, err);
    SendMessage(GUI, "Could not load page of sensor records.");
	ClearInputValues();
    sensorRecordDate = '';
  } 
  else 
  {
  	document.getElementById("sensorRecordDate").innerHTML = sensorRecordDate;
	if(data.Count > 0)
	{
      var table = document.getElementById("sensorRecordsTable").getElementsByTagName('tbody')[0];
      var newRow;
	  var rowCount = 1;
      data.Items.forEach(
	    function(item) 
	    {
		  newRow = table.insertRow(table.rows.length);
		  if(rowCount % 2 != 0)
		  {
		    newRow.bgColor = 'lightgray';
	      }
		  
          newRow.innerHTML = "<tr>" + "<td>" + item.date + "</td>" +
		                              "<td>" + item.day_ts_loc + "</td>" +
								      "<td>" + item.temp + "</td>" +
		                              "<td>" + item.battery + "</td>" +
		                              "<td>" + item.sms1 + "</td>" +
		                              "<td>" + item.sms2 + "</td>" +
		                              "<td>" + item.sms3 + "</td>" +
		                              "<td>" + item.id + "</td></tr>";
		  ++rowCount;
        }
	  );
	  
      SendMessage(GUI, "Finished loading a page of sensor records.");

      //is there more than a single result set page?
      if (typeof data.LastEvaluatedKey != "undefined") 
	  { 
        //VinSensorData partition key is 'year-mo.' Global variable sensorRecordDate
        //contains 'year-mo-dy' so drop the '-dy' when matching a date. 'dy' is used
        //in 'begins_with' function used on sort key to get all records for specific day
	    var params = 
        {
          TableName: 'table_name3',
		  ExclusiveStartKey: data.LastEvaluatedKey,
	      KeyConditionExpression: '#dt = :ym and begins_with(day_ts_loc, :d)',
	      ScanIndexForward: false,
          ExpressionAttributeNames: {'#dt': 'date'},
	      ExpressionAttributeValues: {':ym': sensorRecordDate.substring(0,7), 
	                                  ':d' : sensorRecordDate.substring(8,10)} 
        };
	  
        var docClient = new AWS.DynamoDB.DocumentClient();
	    SendMessage(GUI, "Loading next page of sensor records...");
        docClient.query(params, OnSensorRecordsQuery);
	  }
	  else
	  {
	    SendMessage(GUI, "Finished loading all sensor records.");
	    ClearInputValues();
        sensorRecordDate = '';
	  }
	}
	else
	{
      SendMessage(GUI, "No sensor records in database for specified date.");
	  ClearInputValues();
      sensorRecordDate = '';
	}
  }
}

  
/////////////////////////////////////////////////////////////////////////////////////////
// The following script commands will be executed once: at page load time
/////////////////////////////////////////////////////////////////////////////////////////

//disable GUI
SetTheGUI(true);

// For entire GUI, connect buttons to callback functions
HookUpVineyardStationButtons();
HookUpSensorRecordsButtons();

</script>

</body>
</html>